## Техническое задание

**Устройство раннего предупреждения о засоре мусоропроводного ствола**
Версия **1.3** —  11 июня 2025 г.

### 0. Изменения по сравнению с v1.2 (корректировки после аудита UI)

| №   | Что выявлено                                                                                                | Решение / правка                                                                                                              |
| --- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| 0.1 | В UI **есть** поля Wi-Fi и MQTT, но **нет** названия объекта (идентификатора станции)                       | Добавить поле **`SiteName`** (ASCII, ≤ 24 симв.). Используется во всех MQTT-топиках вместо `chipid`, а также в OTA-заголовке. |
| 0.2 | Смена пароля для UI предусмотрена, но **нет кнопки** «Изменить пароль» — приходится сохранять все настройки | В раздел «Учётная запись UI» добавить отдельную форму «Сменить пароль» (POST `/api/password`).                                |
| 0.3 | OTA-обновление реализовано на `/update`, но в интерфейсе нет ссылки                                         | Кнопка «Обновить прошивку» (открывает `<form enctype="multipart/form-data" action="/update" method="POST">`).                 |
| 0.4 | Настройки MQTT присутствуют, но нет поля **QoS**                                                            | Добавить выбор 0 / 1 / 2 (по умолчанию 0).                                                                                    |
| 0.5 | Поле «Debug-включение» в ТЗ обсуждалось, но в UI отсутствует                                                | Переключатель «Отправлять debug-сообщения» (`debugEnable`).                                                                   |

Все пункты 0.1–0.5 внесены в ТЗ v1.3 и реализованы в программе **release-v1.3** (см. историю Git-коммитов).

---

### 1. Назначение

Компактный узел на базе **ESP32-S3** для мониторинга ствола мусоропровода. Определяет:

* **приближение мусора** к окну выброса (SF11c — лидар);
* **задымление / возможное возгорание** (MQ-2);
* **повышенную концентрацию VOC/CO₂** (ENS160) и вспомогательные t°, RH (AHT21);
* **качество тяги** в стволе (датчик дифференциального давления).

Система предупреждает о засоре заблаговременно и позволяет оператору, при необходимости, «осмотреть» ствол, поворачивая датчик.

---

### 2. Состав устройства

| Узел                      | Модель              | Интерфейс              | GPIO (по умолчанию) |
| ------------------------- | ------------------- | ---------------------- | ------------------- |
| MCU                       | ESP32-S3 DevKit-C-1 | —                      | —                   |
| Лидар                     | SF11c               | UART 1 @115 200 8-N-1  | RX = 9, TX = 10     |
| Дым                       | MQ-2                | ADC (0–3.3 В)          | 34                  |
| VOC / eCO₂                | ENS160              | I²C (SDA = 8, SCL = 3) | —                   |
| Temp/RH                   | AHT21               | I²C (общ.)             | —                   |
| Дифференциальное давление | SDP810              | I²C (общ.)             | —                   |
| Серво X                   | DS3218              | PWM 50 Гц              | 4                   |
| Серво Y                   | DS3218              | PWM 50 Гц              | 5                   |
| LED-статус                | on-board            | GPIO                   | 2                   |

---

### 3. Конфигурация (настраивается в веб-интерфейсе)

| Группа            | Поле                                                             | Тип / диапазон         | По умолчанию                       | Назначение                                                    |
| ----------------- | ---------------------------------------------------------------- | ---------------------- | ---------------------------------- | ------------------------------------------------------------- |
| **Объект**        | `SiteName`                                                       | Строка ≤ 24            | `UNDEF`                            | Отображается в UI, входит в MQTT-топики.                      |
| **Wi-Fi**         | `SSID`, `Password`                                               | строки                 | —                                  | STA-режим; при пустом SSID запускается AP `start/starttrats`. |
| **MQTT**          | `Host`, `Port`, `User`, `Pass`, `QoS`                            | host/uint16/строки/0-2 | `broker.hivemq.com` / 1883 / — / 0 | Подключение к брокеру.                                        |
| **UI-учётка**     | `User`, `Password`            | строки                 | `admin/admin`                      | HTTP Basic, пароль хранится как SHA-256.                     |
| **Пороги**        | `Lidar.min/max`, `Smoke.min/max`, `ECO2.min/max`, `TVOC.min/max` | float                  | см. §5                             | События «выброс».                                             |
| **Clog-алгоритм** | `ClogMin` (мм), `ClogHold` (циклы 10 мин)                        | uint16, uint8          | 400 мм, 2                          | Детектор засора.                                              |
| **Debug**         | `debugEnable`                                                    | bool                   | `false`                            | Публикация `/debug`.                                          |

---

### 4. Функциональные требования (обновлённая таблица)

| Код | Описание                              | Период / триггер                        | Действие                                                             |
| --- | ------------------------------------- | --------------------------------------- | -------------------------------------------------------------------- |
| F1  | **Периодический SF11c**               | 10 мин (или 100 мс после движения серв) | измерить, сравнить с `Lidar.min/max`, event MQTT                     |
| F2  | **Периодические MQ-2, ENS160, AHT21** | 1 мин                                   | median/SMA, сравнить с порогами                                      |
| F3  | **Heartbeat**                         | 1 ч                                     | MQTT `/heartbeat` (последние значения + sysinfo)                     |
| F4  | **Clog-детектор**                     | каждые 10 мин                           | если `Lidar<ClogMin` N циклов ≥ `ClogHold` → `event/clog`, LED=ALARM |
| F5  | **Ручное позиционирование**           | WebSocket `X±`, `Y±` (±1°)              | Обновить углы, через 100 мс переизмерить лидар                       |
| F6  | **Буфер offline**                     | MQTT offline                            | RAM→LittleFS; при reconnect → flush                                  |
| F7  | **OTA**                               | UI-кнопка «Обновить прошивку»           | HTTP POST `/update`, auth req.                                       |
| F8  | **Смена пароля UI**                   | форма «Сменить пароль»                  | POST `/api/password` (Basic auth)                                    |
| F9  | **Live-таблица**                      | каждые 5 с по WS/REST                   | Lidar, Smoke, eCO₂, TVOC, t°, RH, X°, Y°                             |

---

### 5. Пороговые значения по умолчанию

| Датчик | `min` | `max` | Ед.                       |
| ------ | ----- | ----- | ------------------------- |
| Lidar  | 0     | 1500  | мм                        |
| Smoke  | 0     | 400   | ppm (сырое MQ-2-значение) |
| eCO₂   | 400   | 2000  | ppm                       |
| TVOC   | 0     | 600   | ppb                       |

Гистерезис ±5 % применяется ко всем порогам, чтобы исключить дребезг.

---

### 6. MQTT-топики (с учётом `SiteName`)

```
base = site/<SiteName>/

<base>event/lidar
<base>event/smoke
<base>event/eco2
<base>event/tvoc
<base>event/clog        # новый
<base>heartbeat
<base>debug             # опционально
<base>status            # LWT: offline / online
```

QoS — пользовательский (0/1/2), Retain = false, кроме LWT (retain).

---

### 7. Программная архитектура (обновлённая)

Добавлены два модуля: **MsgBuffer** и **NtpSync**.
LED-FSM теперь имеет 3 состояния: `NORMAL`, `ERROR` (Wi-Fi/MQTT), `ALARM` (clog).

```
Core0 ── WiFiMgr ── NtpSync ── MqttTask ── MsgBuffer
Core1 ── SensorsTask ── ClogFSM
       └─ ServoTask (WebSocket, 100 ms re-lidar)
```

---

### 8. UI (главная страница)

* **Live-панель** → динамическая таблица (Lidar, Smoke, eCO₂, TVOC, t°, RH, X°, Y°).
* **Настройки** → аккордеоны: Wi-Fi, MQTT, Пороги, Clog, Debug, Пароль UI.
* **OTA** → модальный диалог с загрузкой `firmware.bin`.

Все формы используют `/api/settings` (JSON) за один POST; смена пароля — отдельный `/api/password` (SHA-256 → NVS).

---

### 9. LED-индикация

| Состояние          | Шаблон                                     |
| ------------------ | ------------------------------------------ |
| NORMAL             | 100 мс ON ---- 9900 мс OFF                 |
| ERROR (Wi-Fi/MQTT) | \[ON-100 мс, OFF-100 мс] ×2 → пауза 800 мс |
| ALARM (Clog)       | 500 мс ON / 500 мс OFF                     |

---

Также необходим датчик дифференциального давления для оценки качества тяги в стояке мусоропровода.
